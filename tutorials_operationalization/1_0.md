# Deploy a CPU or GPU enabled AZTK Spark cluster

[todo] script to automate installation of aztk & creation of necessary resources (aad / service principal, batch account, storage account)

To run the following, you need to be logged in on [Azure Cloud Shell](https://shell.azure.com/).

```sh
#!/bin/sh

# set vars
RESOURCE_GROUP_NAME=aztktest01
BATCH_ACCOUNT_NAME=aztktest01
STORAGE_ACCOUNT_NAME=aztktest01
SERVICE_PRINCIPAL_NAME=aztktest01
LOCATION=westus
SERVICE_PRINCIPAL_PASSWORD=pass123!

# create a resource group
echo "Creating your resource group, $RESOURCE_GROUP_NAME"
az group create -n $RESOURCE_GROUP_NAME -l $LOCATION

# create your batch account in said resource group
echo "Creating your batch account, $BATCH_ACCOUNT_NAME"
az batch account create -l westus -n $BATCH_ACCOUNT_NAME -g $RESOURCE_GROUP_NAME

# create your storage account in said resource group
echo "Creating your storage account, $STORAGE_ACCOUNT_NAME"
az storage account create -n $STORAGE_ACCOUNT_NAME -g $RESOURCE_GROUP_NAME -l $LOCATION

# set resource ids for your batch account & storage account
export AZURE_STORAGE_ACCOUNT_RESOURCE_ID=`az storage account show -n $STORAGE_ACCOUNT_NAME -g $RESOURCE_GROUP_NAME | jq '.id' | tr -d '"'`
export AZURE_BATCH_ACCOUNT_RESOURCE_ID=`az batch account show -n $BATCH_ACCOUNT_NAME -g $RESOURCE_GROUP_NAME | jq '.id' | tr -d '"'`

# create your service principal and give it contributor access to your batch and storage accounts
echo "Creating your service principal, $SERVICE_PRINCIPAL_NAME"
az ad sp create-for-rbac -n $SERVICE_PRINCIPAL_NAME --role contributor --password $SERVICE_PRINCIPAL_PASSWORD --scopes $AZURE_BATCH_ACCOUNT_RESOURCE_ID $AZURE_STORAGE_ACCOUNT_RESOURCE_ID

# set 
export AZURE_SP_TENANT_ID=`az ad sp show --id http://$SERVICE_PRINCIPAL_NAME | jq '.additionalProperties.appOwnerTenantId' | tr -d '"'`
export AZURE_SP_APP_ID=`az ad sp show --id http://$SERVICE_PRINCIPAL_NAME | jq '.appId' | tr -d '"'`

echo << EOF
tenant_id: $AZURE_SP_TENANT_ID
client_id: $AZURE_SP_APP_ID
crediential: $SERVICE_PRINCIPAL_PASSWORD
batch_account_resource_id: $AZURE_BATCH_ACCOUNT_RESOURCE_ID
storage_account_resource_id: $AZURE_STORAGE_ACCOUNT_RESOURCE_ID
EOF
```

```sh
service_principal:
    tenant_id: <AAD Diretory ID>
    client_id: <AAD App Application ID>
    credential: <AAD App Password>
    batch_account_resource_id: </batch/account/resource/id>
    storage_account_resource_id: </storage/account/resource/id>
```

One you have AZTK installed on your local machine, deploying a GPU or CPU cluster is just a few steps.

```sh
aztk spark cluster create --id <your_cluster_id> --vm-size <vm_size_name> --size <number_of_nodes>
```
